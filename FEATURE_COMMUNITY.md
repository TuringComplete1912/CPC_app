# 社区功能

## 功能概述

新增社区板块，支持话题讨论和回答功能，促进党员之间的交流互动。

## 主要功能

### 1. 话题管理
- ✅ 创建话题（所有用户）
- ✅ 查看话题列表
- ✅ 删除话题（作者或管理员）
- ✅ 话题包含标题和描述
- ✅ 显示回答数量

### 2. 回答功能
- ✅ 在话题下写回答
- ✅ 每条回答显示作者标签
- ✅ 删除回答（作者或管理员）
- ✅ 回答按时间倒序排列
- ✅ 支持多行文本

### 3. 用户标识
- ✅ 每条回答都有用户头像
- ✅ 显示用户名称
- ✅ 用户标签（Badge）
- ✅ 发布时间

### 4. 导航集成
- ✅ 社区入口在导航栏最左侧
- ✅ 与其他板块统一的导航体验
- ✅ 活跃状态高亮显示

## 数据库模型

### Topic（话题）
```prisma
model Topic {
  id          String   @id @default(uuid())
  title       String
  description String   @default("")
  createdAt   DateTime @default(now())
  author      User
  answers     Answer[]
}
```

### Answer（回答）
```prisma
model Answer {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())
  topic     Topic
  author    User
}
```

## API路由

### 话题API
- `GET /api/topics` - 获取所有话题
- `POST /api/topics` - 创建新话题
- `GET /api/topics/[id]` - 获取单个话题及其回答
- `DELETE /api/topics/[id]` - 删除话题

### 回答API
- `POST /api/topics/[id]/answers` - 在话题下创建回答
- `DELETE /api/answers/[id]` - 删除回答

## 页面路由

- `/community` - 社区首页（话题列表）
- `/community/[id]` - 话题详情页（查看和回答）

## 用户界面

### 社区首页
```
┌─────────────────────────────────────────────────────┐
│ 社区                                    [添加话题]   │
│ 分享交流，共同进步                                   │
├─────────────────────────────────────────────────────┤
│ 💬 话题标题1                                [删除]   │
│    话题描述...                                       │
│    👤 作者 • 🕐 时间 • 5个回答                      │
├─────────────────────────────────────────────────────┤
│ 💬 话题标题2                                [删除]   │
│    话题描述...                                       │
│    👤 作者 • 🕐 时间 • 3个回答                      │
└─────────────────────────────────────────────────────┘
```

### 话题详情页
```
┌─────────────────────────────────────────────────────┐
│ [← 返回社区]                                         │
├─────────────────────────────────────────────────────┤
│ 话题标题                                             │
│ 话题描述...                                          │
│ 👤 发起人 • 🕐 时间 • 5个回答                       │
├─────────────────────────────────────────────────────┤
│ 写回答                                               │
│ ┌─────────────────────────────────────────────┐     │
│ │ 分享你的想法...                              │     │
│ └─────────────────────────────────────────────┘     │
│                                      [提交回答]      │
├─────────────────────────────────────────────────────┤
│ 全部回答 (5)                                         │
│                                                     │
│ 👤 用户名 [用户名]  时间                    [删除]   │
│    回答内容...                                       │
│                                                     │
│ 👤 用户名 [用户名]  时间                    [删除]   │
│    回答内容...                                       │
└─────────────────────────────────────────────────────┘
```

## 权限控制

### 话题
- **创建** - 所有登录用户
- **查看** - 所有登录用户
- **删除** - 作者或管理员

### 回答
- **创建** - 所有登录用户
- **查看** - 所有登录用户
- **删除** - 作者或管理员

## 使用说明

### 创建话题
1. 点击导航栏的"社区"
2. 点击右上角"添加话题"按钮
3. 输入话题标题（必填）
4. 输入话题描述（可选）
5. 点击"确认"创建

### 查看话题
1. 在社区首页浏览话题列表
2. 点击话题卡片进入详情页
3. 查看话题信息和所有回答

### 写回答
1. 进入话题详情页
2. 在"写回答"区域输入内容
3. 点击"提交回答"发布
4. 回答会显示在列表顶部

### 删除内容
1. 鼠标悬停在话题/回答上
2. 点击右侧的删除按钮
3. 在确认对话框中输入"确定移除"
4. 点击"确认删除"

## 特色功能

### 1. 用户标签
每条回答都会显示用户标签（Badge），方便识别回答者身份：
- 显示用户名称
- 品牌色背景
- 醒目的视觉效果

### 2. 实时统计
话题列表显示回答数量，方便了解讨论热度：
- 蓝色Badge显示回答数
- 实时更新
- 直观的数据展示

### 3. 时间线展示
回答按时间倒序排列：
- 最新回答在最上方
- 显示具体发布时间
- 便于追踪讨论进展

### 4. 响应式设计
- 适配不同屏幕尺寸
- 移动端友好
- 流畅的交互体验

## 技术实现

### 数据关联
```typescript
// 话题包含多个回答
Topic {
  answers: Answer[]
}

// 回答属于一个话题和一个用户
Answer {
  topic: Topic
  author: User
}
```

### 级联删除
删除话题时自动删除所有关联的回答：
```prisma
topic Topic @relation(fields: [topicId], references: [id], onDelete: Cascade)
```

### 权限验证
```typescript
// 检查是否可以删除
const isAuthor = item.authorId === currentUser.id;
const isAdmin = currentUser.role === "admin";
const canDelete = isAuthor || isAdmin;
```

## 导航栏更新

社区入口位于导航栏最左侧：
```
[社区] [工作台] [近期文档] [活动日志] [学习园地] [个人主页]
```

顺序说明：
1. **社区** - 交流讨论（新增）
2. **工作台** - 工作概览
3. **近期文档** - 文档管理
4. **活动日志** - 活动记录
5. **学习园地** - 学习资料
6. **个人主页** - 个人信息

## Bug修复

### 文档编辑保存功能
修复了params类型问题：
```typescript
// 修复前
const documentId = params.id as string;

// 修复后
const documentId = params?.id as string;
```

这个修复同时应用于：
- 文档编辑页面
- 活动日志编辑页面
- 话题详情页面

## 数据流程

```
用户登录
  ↓
进入社区
  ↓
查看话题列表
  ↓
点击话题
  ↓
查看详情和回答
  ↓
写回答
  ↓
提交
  ↓
显示在列表顶部
```

## 注意事项

### 内容管理
- 话题和回答一旦创建无法编辑
- 只能删除，不能修改
- 删除话题会同时删除所有回答
- 删除操作需要确认

### 用户体验
- 回答支持多行文本
- 自动保留换行格式
- 长内容自动滚动
- 响应式布局

### 性能优化
- 话题列表一次性加载
- 回答按需加载（进入详情页时）
- 使用索引优化查询
- 级联删除提高效率

## 未来改进

可能的功能增强：
- [ ] 支持回答编辑
- [ ] 添加点赞功能
- [ ] 支持回复回答（二级评论）
- [ ] 话题分类和标签
- [ ] 搜索和筛选功能
- [ ] 热门话题推荐
- [ ] 通知提醒
- [ ] 富文本编辑器
- [ ] 图片上传
- [ ] @提及用户

## 总结

社区功能为党支部成员提供了一个交流讨论的平台：
- 简单易用的话题创建
- 便捷的回答功能
- 清晰的用户标识
- 完善的权限控制

通过社区功能，党员可以：
- 分享学习心得
- 讨论工作问题
- 交流活动经验
- 增进相互了解

所有功能已完成开发并通过测试，可以正常使用！
