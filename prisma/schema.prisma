// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id              String          @id @default(uuid())
  username        String          @unique
  password        String
  nickname        String          @default("")
  department      String          @default("")
  avatar          String          @default("")
  role            String          @default("user")
  createdAt       DateTime        @default(now())
  
  // 个人资料（仅个人主页展示）
  bio             String          @default("") // 个人简介
  phone           String          @default("") // 联系电话
  email           String          @default("") // 邮箱
  
  // AI功能
  apiKey          String          @default("") // 用户的API key
  useOwnApiKey    Boolean         @default(false) // 是否优先使用自己的API key
  
  materials       Material[]
  workLogs        WorkLog[]
  files           File[]
  categories      Category[]      @relation("CategoryCreator")
  workLogEdits    WorkLogEditor[]
  documentEdits   DocumentEditor[]
  documents       Document[]
  topics          Topic[]
  answers         Answer[]
  answerLikes     AnswerLike[]
  replies         Reply[]
  partyInfo       PartyInfo?
}

model PartyInfo {
  id                    String    @id @default(uuid())
  userId                String    @unique
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // 基本信息
  politicalStatus       String    @default("群众") // 政治面貌：群众、共青团员、入党积极分子、预备党员、党员
  className             String    @default("") // 班级（标准化格式，如：2201班）
  hometown              String    @default("") // 籍贯
  wechatQQ              String    @default("") // 微信号/QQ号
  
  // 时间节点
  joinLeagueDate        DateTime? // 入团时间
  activistDate          DateTime? // 成为积极分子时间
  probationaryDate      DateTime? // 成为预备党员时间
  formalDate            DateTime? // 成为正式党员时间
  
  // 隐私设置
  showPoliticalStatus   Boolean   @default(true)
  showClassName         Boolean   @default(true)
  showHometown          Boolean   @default(true)
  showWechatQQ          Boolean   @default(false)
  showJoinLeagueDate    Boolean   @default(true)
  showActivistDate      Boolean   @default(true)
  showProbationaryDate  Boolean   @default(true)
  showFormalDate        Boolean   @default(true)
  
  updatedAt             DateTime  @updatedAt
  createdAt             DateTime  @default(now())
}

model Document {
  id          String             @id @default(uuid())
  title       String
  content     String
  status      String             @default("draft") // draft, published
  createdAt   DateTime           @default(now())
  publishedAt DateTime?

  author      User               @relation(fields: [authorId], references: [id])
  authorId    String
  editors     DocumentEditor[]
  attachments DocumentAttachment[]
}

model DocumentEditor {
  id         String   @id @default(uuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  editedAt   DateTime @default(now())

  @@unique([documentId, userId])
}

model DocumentAttachment {
  id         String   @id @default(uuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  filename   String
  url        String
  size       Int
  createdAt  DateTime @default(now())
}

model Category {
  id          String     @id @default(uuid())
  name        String     @unique // 板块名称（大字展示）
  description String     @default("") // 基本介绍（小字展示）
  type        String     @default("course") // 类型：theory(理论学习) 或 course(课程学习)
  createdAt   DateTime   @default(now())
  creatorId   String
  creator     User       @relation("CategoryCreator", fields: [creatorId], references: [id])
  materials   Material[]
}

model Material {
  id         String   @id @default(uuid())
  title      String
  fileUrl    String
  fileType   String
  fileSize   Int      @default(0) // 文件大小（字节）
  createdAt  DateTime @default(now())

  uploader   User     @relation(fields: [uploaderId], references: [id])
  uploaderId String

  category   Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  categoryId String?
}

model WorkLog {
  id          String   @id @default(uuid())
  title       String
  content     String
  status      String   @default("draft") // draft, published
  createdAt   DateTime @default(now())
  publishedAt DateTime?

  author      User                @relation(fields: [authorId], references: [id])
  authorId    String
  editors     WorkLogEditor[]
  attachments WorkLogAttachment[]
}

model WorkLogEditor {
  id         String   @id @default(uuid())
  workLogId  String
  workLog    WorkLog  @relation(fields: [workLogId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  editedAt   DateTime @default(now())

  @@unique([workLogId, userId])
}

model WorkLogAttachment {
  id        String   @id @default(uuid())
  workLogId String
  workLog   WorkLog  @relation(fields: [workLogId], references: [id], onDelete: Cascade)
  filename  String
  url       String
  size      Int
  createdAt DateTime @default(now())
}

model File {
  id         String   @id @default(uuid())
  filename   String
  path       String
  url        String
  mimeType   String
  size       Int
  createdAt  DateTime @default(now())

  uploader   User   @relation(fields: [uploaderId], references: [id])
  uploaderId String
}

model Topic {
  id          String   @id @default(uuid())
  title       String
  description String   @default("")
  createdAt   DateTime @default(now())

  author      User     @relation(fields: [authorId], references: [id])
  authorId    String
  answers     Answer[]
}

model Answer {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())

  topic     Topic        @relation(fields: [topicId], references: [id], onDelete: Cascade)
  topicId   String
  author    User         @relation(fields: [authorId], references: [id])
  authorId  String
  likes     AnswerLike[]
  replies   Reply[]
}

model AnswerLike {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  answer    Answer @relation(fields: [answerId], references: [id], onDelete: Cascade)
  answerId  String
  user      User   @relation(fields: [userId], references: [id])
  userId    String

  @@unique([answerId, userId])
}

model Reply {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())

  answer    Answer @relation(fields: [answerId], references: [id], onDelete: Cascade)
  answerId  String
  author    User   @relation(fields: [authorId], references: [id])
  authorId  String
}
